
/**
 * This ruleset enforces a strict user-ownership security model for the Skill Garden application.
 *
 * Core Philosophy:
 * Every piece of data, including profiles, stems, and leaves, is considered private
 * and is accessible only by the user who created it. There is no concept of public data
 * or shared access between users.
 *
 * Data Structure:
 * All user-specific data is hierarchically nested under a top-level `/users` collection,
 * using the user's authentication UID as the document key (e.g., /users/{userId}/...).
 * This structure enables simple, performant, and secure path-based authorization.
 *
 * Key Security Decisions:
 * - Strict Ownership: All read and write operations are gated by a check that ensures the
 *   requesting user's UID matches the {userId} in the document path.
 * - No Public Listing: It is impossible for any user, authenticated or not, to list all
 *   users in the `/users` collection.
 * - Relational Integrity: On creation, documents must contain an ID field that correctly
 *   references their parent in the path. These relational IDs are immutable and cannot be changed on update.
 *
 * Denormalization for Authorization:
 * The security model relies entirely on the path structure for authorization. This avoids
 * slow and costly `get()` calls to other documents to verify ownership, resulting in
 * faster and more reliable security enforcement.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the core function for enforcing user ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true for update/delete ops if the user is the owner and the document exists.
     * Protects against modifying or deleting non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the UserProfile being created has an `id` field that
     * correctly matches the user's UID from the path.
     */
    function isValidUserProfileCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates that the UserProfile's `id` field is immutable on update.
     */
    function isImmutableUserProfile() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that the Stem being created has a `userId` field that
     * correctly matches the user's UID from the path.
     */
    function isValidStemCreate(userId) {
      return request.resource.data.userId == userId;
    }

    /**
     * Validates that the Stem's `userId` field is immutable on update.
     */
    function isImmutableStem() {
      return request.resource.data.userId == resource.data.userId;
    }

    /**
     * Validates that the Leaf being created belongs to the correct user.
     * This rule allows a leaf to be created in the same transaction as its parent stem.
     */
    function isValidLeafCreate(userId) {
       return request.resource.data.userId == userId;
    }

    /**
     * Validates that the Leaf's `stemId` and 'userId' fields are immutable on update.
     */
    function isImmutableLeaf() {
      return request.resource.data.stemId == resource.data.stemId && request.resource.data.userId == resource.data.userId;
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Secures user profile documents. Only the owner can manage their profile.
     * @path /users/{userId}/profile/{profileId}
     */
    match /users/{userId}/profile/{profileId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isValidUserProfileCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableUserProfile();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures Stems within a user's collection.
     * @path /users/{userId}/stems/{stemId}
     */
    match /users/{userId}/stems/{stemId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isValidStemCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableStem();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures Leaves (skills).
     * @path /users/{userId}/leaves/{leafId}
     */
    match /users/{userId}/leaves/{leafId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isValidLeafCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableLeaf();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures user stats documents.
     * @path /users/{userId}/stats/{statsId}
     */
    match /users/{userId}/stats/{statsId} {
        allow get: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isOwner(userId);
        allow delete: if false; // Stats should not be deletable by clients
    }
  }
}
