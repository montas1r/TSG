/**
 * This ruleset enforces a strict user-ownership security model for the Skill Garden application.
 *
 * Core Philosophy:
 * Every piece of data, including profiles, gardens, stems, and leaves, is considered private
 * and is accessible only by the user who created it. There is no concept of public data
 * or shared access between users.
 *
 * Data Structure:
 * All user-specific data is hierarchically nested under a top-level `/users` collection,
 * using the user's authentication UID as the document key (e.g., /users/{userId}/...).
 * This structure enables simple, performant, and secure path-based authorization.
 *
 * Key Security Decisions:
 * - Strict Ownership: All read and write operations are gated by a check that ensures the
 *   requesting user's UID matches the {userId} in the document path.
 * - No Public Listing: It is impossible for any user, authenticated or not, to list all
 *   users in the `/users` collection.
 * - Relational Integrity: On creation, documents must contain an ID field that correctly
 *   references their parent in the path (e.g., a new SkillGarden must have a `userId` field
 *   matching the path). These relational IDs are immutable and cannot be changed on update.
 *
 * Denormalization for Authorization:
 * The security model relies entirely on the path structure for authorization. This avoids
 * slow and costly `get()` calls to other documents to verify ownership, resulting in
 * faster and more reliable security enforcement.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the core function for enforcing user ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true for update/delete ops if the user is the owner and the document exists.
     * Protects against modifying or deleting non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the UserProfile being created has an `id` field that
     * correctly matches the user's UID from the path.
     */
    function isValidUserProfileCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates that the UserProfile's `id` field is immutable on update.
     */
    function isImmutableUserProfile() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that the SkillGarden being created has a `userId` field that
     * correctly matches the user's UID from the path.
     */
    function isValidGardenCreate(userId) {
      return request.resource.data.userId == userId;
    }

    /**
     * Validates that the SkillGarden's `userId` field is immutable on update.
     */
    function isImmutableGarden() {
      return request.resource.data.userId == resource.data.userId;
    }

    /**
     * Validates that the Stem being created has a `gardenId` field that
     * correctly matches the garden's ID from the path.
     */
    function isValidStemCreate(gardenId) {
      return request.resource.data.gardenId == gardenId;
    }

    /**
     * Validates that the Stem's `gardenId` field is immutable on update.
     */
    function isImmutableStem() {
      return request.resource.data.gardenId == resource.data.gardenId;
    }

    /**
     * Validates that the Leaf being created has a `stemId` field that
     * correctly matches the stem's ID from the path.
     */
    function isValidLeafCreate(stemId) {
      return request.resource.data.stemId == stemId;
    }

    /**
     * Validates that the Leaf's `stemId` field is immutable on update.
     */
    function isImmutableLeaf() {
      return request.resource.data.stemId == resource.data.stemId;
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Secures user profile documents. Only the owner can manage their profile.
     * @path /users/{userId}/profile/{profileId}
     * @allow A user (auth.uid='user123') can (create) their own profile document at /users/user123/profile/main.
     * @deny A user (auth.uid='user456') cannot (get) a profile at /users/user123/profile/main.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/profile/{profileId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isValidUserProfileCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableUserProfile();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures a user's collection of Skill Gardens.
     * @path /users/{userId}/gardens/{gardenId}
     * @allow A user (auth.uid='user123') can (list) all their gardens at /users/user123/gardens.
     * @deny A user (auth.uid='user456') cannot (create) a garden at /users/user123/gardens/garden_abc.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/gardens/{gardenId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isValidGardenCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableGarden();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures Stems within a user's Skill Garden.
     * @path /users/{userId}/gardens/{gardenId}/stems/{stemId}
     * @allow A user (auth.uid='user123') can (update) a stem at /users/user123/gardens/garden_abc/stems/stem_def.
     * @deny A user (auth.uid='user456') cannot (delete) a stem at /users/user123/gardens/garden_abc/stems/stem_def.
     * @principle Path-based ownership restricts access to nested subcollections.
     */
    match /users/{userId}/gardens/{gardenId}/stems/{stemId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isValidStemCreate(gardenId);
      allow update: if isExistingOwner(userId) && isImmutableStem();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures Leaves (skills) within a Stem.
     * @path /users/{userId}/gardens/{gardenId}/stems/{stemId}/leaves/{leafId}
     * @allow A user (auth.uid='user123') can (create) a leaf with a valid `stemId` at /users/user123/gardens/g1/stems/s1/leaves/l1.
     * @deny A user (auth.uid='user456') cannot (get) a leaf at /users/user123/gardens/g1/stems/s1/leaves/l1.
     * @principle Path-based ownership restricts access to nested subcollections.
     */
    match /users/{userId}/gardens/{gardenId}/stems/{stemId}/leaves/{leafId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isValidLeafCreate(stemId);
      allow update: if isExistingOwner(userId) && isImmutableLeaf();
      allow delete: if isExistingOwner(userId);
    }
  }
}